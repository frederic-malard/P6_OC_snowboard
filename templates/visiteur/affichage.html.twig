{% extends 'base.html.twig' %}

{% block title %}{{ figure.nom }}{% endblock %}

{% form_theme form _self %}

{% block body %}

{# image en tête : première image, s'il n'y a pas d'images, une image par défaut. image d'en tête de l'accueil ? #}

{% if figure.illustrations|length > 0 %}
    <header class="m-0 w-100" style="height: 100vh; min-height: 500px; background-image: url('{{ figure.illustrations[0].url }}'); background-size: cover; background-position: center; background-repeat: no-repeat; color: #fea; text-shadow: 3px 3px 3px black;">
{% else %}
    <header class="m-0 w-100" style="height: 100vh; min-height: 500px; background-image: url('/images/enTete.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; color: #fea; text-shadow: 3px 3px 3px black;">
{% endif %}
    <div class="container h-100">
        <div class="row h-100 align-items-center">
            <div class="col-12 text-center">
                <h1 class="font-weight-bold text-uppercase" style="color: #fea;">
                    {{ figure.nom }}
                </h1>
                <p class="lead">
                    test
                </p>
            </div>
        </div>
    </div>
</header>

{# modifier ou supprimer #}
{% if app.user == figure.editeur or (app.user and "ROLE_MODO" in app.user.roles) %}
    <div class="float-right" style="margin-top: -3em; margin-right: 1em; font-size: 2em;">
        <a href="{{ path("modifier_figure", {"slug" : figure.slug}) }}" style="color: #fea;" class="text-warning">
            <i class="fas fa-pencil-alt">
            </i>
        </a>
        <a href="{{ path("supprimer_figure", {"slug" : figure.slug}) }}" style="color: #fea;" class="ml-3 text-danger">
            <i class="fas fa-trash-alt">
            </i>
        </a>
    </div>
{% endif %}

{# illustrations et vidéos #}
<div class="d-sm-flex justify-content-center flex-wrap">
    {% for illustration in figure.illustrations %}
        <img src="{{ illustration.url }}" alt="{{ illustration.alt }}" style="display: block; width: 250px;" class="mx-auto my-3">
    {% endfor %}
    {% for video in figure.videos %}
        <iframe src="https://www.youtube.com/embed/pYJbes1VChQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="width: 250px;" class="mx-auto my-3">{{ video.alt }}</iframe>
    {% endfor %}
</div>

<div class="container my-4 jumbotron">
    {# description #}
    {{ figure.description }}

    {# données importantes : date création, groupe, date modification si existe #}
    <div class="text-center mt-5">
        <span class="badge badge-primary mx-auto my-3">
            {{ figure.getDateCreationString() }}
        </span>
        <span class="badge badge-primary mx-auto my-3">
            {{ figure.groupe.nom }}
        </span>
        {% if not figure.dateModification is null %}
            <span class="badge badge-primary mx-auto my-3">
                {{ figure.getDateModificationString() }}
            </span>
        {% endif %}
        {% if app.user and "ROLE_MODO" in app.user.roles %}
            <span class="badge badge-primary mx-auto my-3">
                {% if figure.editeur is defined and not figure.editeur is null %}
                    {{ figure.editeur.login }} {# pour modération : modo peut retrouver l'éditeur dans l'interface de gestion des comptes s'il troll ou créé n'importe quoi volontairement #}
                {% elseif not figure.editeur is defined or figure.editeur is null %}
                    utilisateur supprimé
                {% endif %}
            </span>
        {% endif %}
    </div>

    {# difficulté #}

    {% set opacite = 0.2 %}
    {% set nbAffiches = 0 %}

    {% if nbAffichages > 0 %}

        <div class="bg-dark text-center text-white py-4 my-4">

        <p class="text-uppercase">
            difficulté de la figure
        </p>

        {% if nbAffichages > 1 %}
            <div class="row">
        {% endif %}
        
        {% if nbAffichages == 2 %}
            <div class="col-sm-6">
        {% endif %}

        {% if nbAffichages == 3 %}
            <div class="col-md-4">
        {% endif %}

            {# affichage note éditeur si l'éditeur n'est pas l'utilisateur courant (sinon ferait doublon avec la suite) #}
            {% if not difficulteEditeur is null and not utilisateurCourantEstEditeur %}
                {% set rouge = min(((difficulteEditeur.note-1)*(255/4.5)), 255)|round %}
                {% set vert = min(((10-difficulteEditeur.note)*(255/4.5)), 255)|round %}

                <p style="color : rgb({{ rouge }}, {{ vert }}, 0)">
                    <span class="">
                        selon l'éditeur
                    </span> 
                    
                    <br>

                    {% for i in 1..difficulteEditeur.note %}
                        <i class="fas fa-skull-crossbones"></i>
                    {% endfor %}
                    {% if difficulteEditeur.note != 10 %}
                        {% for i in 1..(10-difficulteEditeur.note) %}
                            <i class="fas fa-skull-crossbones" style="color : rgba({{ rouge }}, {{ vert }}, 0, {{ opacite }})"></i>
                        {% endfor %}
                    {% endif %}

                    <br>

                    <span>
                        {% if difficulteEditeur.note == 1 %}
                            initiation
                        {% elseif difficulteEditeur.note == 2 %}
                            débutant
                        {% elseif difficulteEditeur.note == 3 %}
                            facile
                        {% elseif difficulteEditeur.note == 4 %}
                            y'a du niveau !
                        {% elseif difficulteEditeur.note == 5 %}
                            pas mal !
                        {% elseif difficulteEditeur.note == 6 %}
                            connaisseur
                        {% elseif difficulteEditeur.note == 7 %}
                            maîtrise
                        {% elseif difficulteEditeur.note == 8 %}
                            pro
                        {% elseif difficulteEditeur.note == 9 %}
                            hardcore !
                        {% elseif difficulteEditeur.note == 10 %}
                            légendaire
                        {% endif %}
                    </span>
                </p>
                
                {% set nbAffiches = 1 %}

                {% if nbAffichages == 2 %}
                    </div>
                    <div class="col-sm-6">
                {% endif %}

                {% if nbAffichages == 3 %}
                    </div>
                    <div class="col-md-4">
                {% endif %}
            {% endif %}

            {# affichage note moyenne sans compter l'éditeur #}
            {% if not difficultesAutres|length == 0 %}
                {% set rouge = min(((difficulteMoyenneSansEditeur-1)*(255/4.5)), 255)|round %}
                {% set vert = min(((10-difficulteMoyenneSansEditeur)*(255/4.5)), 255)|round %}

                <p style="color : rgb({{ rouge }}, {{ vert }}, 0)">
                    <span class="">
                        moyenne des utilisateurs
                    </span>
                    
                    <br>

                    {% for i in 1..difficulteMoyenneSansEditeur %}
                        <i class="fas fa-skull-crossbones"></i>
                    {% endfor %}

                    {% if difficulteMoyenneSansEditeur != 10 %}
                        {% for i in 1..(10-difficulteMoyenneSansEditeur) %}
                            <i class="fas fa-skull-crossbones" style="color : rgba({{ rouge }}, {{ vert }}, 0, {{ opacite }})"></i>
                        {% endfor %}
                    {% endif %}

                    <br>

                    <span>
                        {% if difficulteMoyenneSansEditeur == 1 %}
                            initiation
                        {% elseif difficulteMoyenneSansEditeur == 2 %}
                            débutant
                        {% elseif difficulteMoyenneSansEditeur == 3 %}
                            facile
                        {% elseif difficulteMoyenneSansEditeur == 4 %}
                            y'a du niveau !
                        {% elseif difficulteMoyenneSansEditeur == 5 %}
                            pas mal !
                        {% elseif difficulteMoyenneSansEditeur == 6 %}
                            connaisseur
                        {% elseif difficulteMoyenneSansEditeur == 7 %}
                            maîtrise
                        {% elseif difficulteMoyenneSansEditeur == 8 %}
                            pro
                        {% elseif difficulteMoyenneSansEditeur == 9 %}
                            hardcore !
                        {% elseif difficulteMoyenneSansEditeur == 10 %}
                            légendaire
                        {% endif %}
                    </span>
                </p>
                
                {% set nbAffiches = nbAffiches + 1 %}

                {% if nbAffichages == 2 and nbAffichages != nbAffiches %}
                    </div>
                    <div class="col-sm-6">
                {% endif %}

                {% if nbAffichages == 3 %}
                    </div>
                    <div class="col-md-4">
                {% endif %}
            {% endif %}

            {# affichage note utilisateur courant s'il en a mit une #}
            {% if not difficulteUtilisateurCourant is null %}
                {% set rouge = min(((difficulteUtilisateurCourant.note-1)*(255/4.5)), 255)|round %}
                {% set vert = min(((10-difficulteUtilisateurCourant.note)*(255/4.5)), 255)|round %}

                <p style="color : rgb({{ rouge }}, {{ vert }}, 0)">
                    <span class="">
                        votre avis
                    </span>
                    
                    <br>

                    {% for i in 1..difficulteUtilisateurCourant.note %}
                        <a href="{{ path("noter_difficulte", {"note" : i, "slugFigure" : figure.slug, "slugUtilisateur" : app.user.slug}) }}" style="color : rgb({{ rouge }}, {{ vert }}, 0)">
                            <i class="fas fa-skull-crossbones"></i>
                        </a>
                    {% endfor %}

                    {% if difficulteUtilisateurCourant.note != 10 %}
                        {% for i in 1..(10-difficulteUtilisateurCourant.note) %}
                            <a href="{{ path("noter_difficulte", {"note" : (i+difficulteUtilisateurCourant.note), "slugFigure" : figure.slug, "slugUtilisateur" : app.user.slug}) }}">
                                <i class="fas fa-skull-crossbones" style="color : rgba({{ rouge }}, {{ vert }}, 0, {{ opacite }})"></i>
                            </a>
                        {% endfor %}
                    {% endif %}

                    <br>

                    <span>
                        {% if difficulteUtilisateurCourant.note == 1 %}
                            initiation
                        {% elseif difficulteUtilisateurCourant.note == 2 %}
                            débutant
                        {% elseif difficulteUtilisateurCourant.note == 3 %}
                            facile
                        {% elseif difficulteUtilisateurCourant.note == 4 %}
                            y'a du niveau !
                        {% elseif difficulteUtilisateurCourant.note == 5 %}
                            pas mal !
                        {% elseif difficulteUtilisateurCourant.note == 6 %}
                            connaisseur
                        {% elseif difficulteUtilisateurCourant.note == 7 %}
                            maîtrise
                        {% elseif difficulteUtilisateurCourant.note == 8 %}
                            pro
                        {% elseif difficulteUtilisateurCourant.note == 9 %}
                            hardcore !
                        {% elseif difficulteUtilisateurCourant.note == 10 %}
                            légendaire
                        {% endif %}
                    </span>
                </p>
            {% endif %}

            {# pour l'utilisateur courant, si est connecté mais n'a pas noté : affichage têtes grisées, qui serviront à noter en cliquant sur l'une d'elle #}
            {% if app.user and difficulteUtilisateurCourant is null %}
                
                <p>
                    <span class="">
                        votre avis
                    </span>
                    
                    <br>

                    {% for i in 1..10 %}
                        <a href="{{ path("noter_difficulte", {"note" : i, "slugFigure" : figure.slug, "slugUtilisateur" : app.user.slug}) }}">
                            <i class="fas fa-skull-crossbones" style="color : rgba(255, 255, 255, 0.2)"></i>
                        </a>
                    {% endfor %}
                </p>
            {% endif %}

        {% if nbAffichages == 3 %}
            </div>
        {% endif %}

        {% if nbAffichages == 2 %}
            </div>
        {% endif %}

        {% if nbAffichages > 1 %}
            </div>
        {% endif %}

        </div>
        
    {% endif %}

    {# formulaire d'ajout de commentaire (si inscrit) #}

    {% if app.user %}
        <hr class="my-5">

        {{ form(form) }}
    {% endif %}

    {# derniers commentaires #}

    <hr class="my-5">

    <div id="commentaires">
        {% for commentaire in figure.commentaires|reverse %}
            {% if loop.index > 7 %}
                <div class="commentaire m-3 d-none">
            {% else %}
                <div class="commentaire m-3 d-block">
            {% endif %}
                {% if commentaire.auteur.avatar is defined and not commentaire.auteur.avatar is null %}
                    <img src="{{ commentaire.auteur.avatar }}" alt="avatar" style="float: left; width: 64px; height: 64px; display:block;">
                {% else %}
                    {# TODO : mettre un avatar par défaut genre bonhomme bleu #}
                {% endif %}
                <div style="margin-left: 80px;">
                    <p class="float-right">
                        <button class="badge badge-warning signalerCommentaire" style="border: 0px;" id="signaler{{ commentaire.id }}">
                            signaler
                        </button>
                        {% if app.user and "ROLE_MODO" in app.user.roles %}
                            <button class="badge badge-danger supprimerCommentaire" style="border: 0px;" id="supprimer{{ commentaire.id }}">
                                supprimer
                            </button>
                        {% endif %}
                    </p>
                    <p class="lead">
                        {{ commentaire.auteur.login }} - le {{ commentaire.getDateCreationString() }}
                    </p>
                    <p>
                        {{ commentaire.contenu }}
                    </p>
                </div>
            </div>
        {% endfor %}
    </div>

    {# bouton de chargement de commentaires #}
    
</div>

{% endblock %}

{% block javascripts %}

    <script type="text/javascript">
        $pathSignaler = "{{ path("signaler_commentaire", {"slug" : figure.slug, "idCommentaire" : "id"}) }}";
        $pathSupprimer = "{{ path("supprimer_commentaire", {"slug" : figure.slug, "idCommentaire" : "id"}) }}";
    </script>
    <script src="/js/gestionCommentaires.js"></script>

{% endblock %}